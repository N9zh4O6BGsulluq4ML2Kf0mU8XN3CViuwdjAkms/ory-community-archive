<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Token introspection of client creds does not return meta information</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>
  
  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="66" alt="ORY Community" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <h3>This is an archive of the community.ory.sh Discourse which is read-only.</h3>
It has been moved to GitHub Discussions, refer here:
<br><br>
<a href="https://github.com/ory/kratos/discussions">ORY Kratos Discussions</a><br>
<a href="https://github.com/ory/hydra/discussions">ORY Hydra Discussions</a><br>
<a href="https://github.com/ory/oathkeeper/discussions">ORY Oathkeeper Discussions</a><br>
<a href="https://github.com/ory/keto/discussions">ORY Keto Discussions</a><br>

    <h1 class="topic-title">Token introspection of client creds does not return meta information</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/515_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ajmckee</div>
          <div class="post_content">
<p>Reposting here at the suggestion of <span class="mention">@hackerman</span> from the slack channel;</p>
<p><strong>The Problem:</strong><br/>
When making a introspection request for a token that was generated via a registered auth code client, extra information that was assigned when the session is created is returned in the response allowing oathkeeper to use it within the id_token mutator.</p>
<p>However, when a client is created with the client_credentials grant type, when a token that was generated by the token endpoint is inspected, it does not return the extra meta information (Or indeed owner values) that where submitted when the client was created.</p>
<p>It is slightly unclear from the the documentation as to if this should be the case, and if this is a deliberate design decision.</p>
<p><strong>The long version</strong>*</p>
<p>We want to allow users to create their own oauth clients using client credentials grant but constrain such client so as to operate only within the context of the user and their associated realm.</p>
<p>When a user signs in via an auth_code flow, they are issued an access token that can be inspected via oathkeeper and thus generate an id_token that can be passed to backend applications.</p>
<pre><code>{
  "active": true,
  "scope": "openid profile myapp offline_access",
  "client_id": "test_ui_dev",
  "sub": "1234567890",
  "exp": 1594892078,
 "iat": 1594888477,
 "iss": "https://hydra.foo.dev/",
 "token_type": "access_token",
 "ext": {
      "realm": {
      "id": 1234567890
   },
 "user": {
    "id": 9876543210
  }
 }
}
</code></pre>
<p>Backend applications can then rely on the id_token custom claims generated via oathkeeper for the required information (user.id and realm.id in this case)</p>
<p>However this breaks down when a request is made via a client with the client_creds grant type. The client was created using the standard method (http client create body to hydra admin endpoint). Amongst its provisions, is the ability to provide extra information (metadata and owner).</p>
<p>If this client requests a token from the hydra/oath2/token endpoint a valid access token is issued. However upon introspection, the response does not include any of the metadata values associated with the client.</p>
<pre><code>{
  "active": true,
  "client_id": "test_client_creds_client",
  "sub": "1234567890",
  "exp": 1594891895,
  "iat": 1594888295,
  "iss": "https://hydra.foo.dev/",
  "token_type": "access_token"
} 
</code></pre>
<p>My expectation here is that the introspection endpoint should have included the metadata information associated with the client.</p>
<p><strong>My questions are;</strong></p>
<ol>
<li>Is this a design decision or oversight?</li>
<li>Is what I am trying to do a good idea (I do want 3rd party clients to register but I want them scoped to just their realm so they get to work only on their data) and consistent with the values of hydra/oathkeeper</li>
</ol>
<p><strong>Workaround</strong><br/>
On oathkeeper using a hydrator to detect the subject name and determine if it is a client or user can be performed to obtain the correct information and pass down onto the next mutator (id_token). While this is fine, it is another small application to maintain and introduces another http request in an increasing chain of them.</p>
<p><strong>Observations</strong><br/>
The “issue” around this appears to stem from the fact that an auth code flow requires a session and during that session the developer is free to add data to the session (access_token, id_token) when accepting the request.</p>
<p>However in this particular use case, a 3rd party registered a client with client creds flow only. As part of that process meta data is attached to the client within hydra. As there is no session active when a request is made for a token to the token endpoint, there is no session information. In pseudo code this in my expectation would have been</p>
<pre><code> if (grant_type === "client_credentials") {
    meta = fetchClientMetaData(client_id)
}
</code></pre>
<p>Appreciate that hydra is golang (I’m just not that comfortable with its sources yet to be able to write a sample in go)</p>
<p>It would make sense to me that a token issued via a client creds grant in the absence of session information should return the static meta_data attached to that client when it was created as part of the introspection request. This would negate the use for a hydrator handler.</p>
<p>Similar, if using the oauth2_client_credentials authenticator for oathkeeper (which I would prefer not to use in the first instance) would still induce this issue.</p>
<p>I would value your thoughts on this use case and if I should progress this to a request for change.</p>
<p>TIA</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/5_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">hackerman</div>
          <div class="post_content">
<p>Thank you for raising this issue, I believe this is in part already discussed in one of the GitHub issues if I’m not mistaken: <a href="https://github.com/ory/hydra/issues/1748">https://github.com/ory/hydra/issues/1748</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/515_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ajmckee</div>
          <div class="post_content">
<p><span class="mention">@hackerman</span> Yes it is, you are right. My thoughts on it would be simply if the meta_data is provided by a client definition, it would appear the intention of the end developer would be to use that again via another exposed endpoint, in this instance introspection one. Especially when you take into account the ecosystem (hydra and oathkeeper together) it would be beneficial IMHO.</p>
<p>I can get around this using a hydrator, but its rather ugly and introduces this additional lookup that could be mitigated. Under some circumstance I can see a use case for this (Perhaps behind a config setting with a default off would make sense too)</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/5_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">hackerman</div>
          <div class="post_content">
<p>The problem with metadata is that it can be set by the client. Using that as information in your application is like allowing someone to change the cookie session data, which would allow me - for example - to say that I’m an administrator. That’s why this isn’t included and why I would be very wary of implementing this.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/515_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ajmckee</div>
          <div class="post_content">
<p>Yes, that is a fair point. However unlike <a href="https://github.com/ory/hydra/issues/1383" rel="nofollow noopener">https://github.com/ory/hydra/issues/1383</a> this is not customising the claim of the access token, but rather providing that meta data on introspection (Indeed it does not have to be client provided data, but maybe some operator customised data, but when I thinking about it, the data is in the db and stored for a reason but only a small fragment of it is available on introspection, it appears logical to me to provide it and let the end user decide if they want it or not).</p>
<p>Should an end developer do this… maybe not, but the cats out of the bag <img alt=":slight_smile:" class="emoji" src="../../../images/slight_smile.png" title=":slight_smile:"/> What people do with the application as it grows is up to them.</p>
<p>Without conditionality within oathkeeper, the mutator will hit the hydrator on each request before passing to the next mutator.</p>
<p>For me it is a matter of where does it seem there is a logical fit for this solution;</p>
<ol>
<li>Don’t provide custom data on token introspection for client_credentials</li>
<li>Do provide custom data on token introspection for client_credentials but must be enabled via config flag (Downstream apps could determine if they want that info then and the level of trust they apply to it)</li>
<li>Leave as it is but switch over to conditionals within oathkeeper (Which seems like a bunch of work), i.e. if token was generated via client credentials, do x otherwise continue pipeline. This would still involve telling oathkeeper on the introspection side to hydra that a client_creds client generated this</li>
</ol>
<p>If it were up to me (and it’s not) I’d provide the meta data (Or full subset of client data) on introspection (We’re following best practices as much as possible but they are only practices). Is the token a session token… well no, should introspection provide more data… probably - you can see I am biased here.</p>
<p>It is fair to say at the moment it is a design decision and one I understand. But I would fall into the camp that client_credentials introspection should supply ext data in its response if available.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/5_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">hackerman</div>
          <div class="post_content">
<p>What we could probably do is include a <code>client</code> subfield in the introspection response which includes all fields of the client (except password hash obviously) and clarify that the data should not be trusted if set by the user in the docs.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/515_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ajmckee</div>
          <div class="post_content">
<p>Yes that appears to be a pragmatic and balanced solution. I’m for it <img alt=":slight_smile:" class="emoji" src="../../../images/slight_smile.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/5_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">hackerman</div>
          <div class="post_content">
<p>Nice, would you also be open to contribute that change? <img alt=":slight_smile:" class="emoji" src="../../../images/slight_smile.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/515_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ajmckee</div>
          <div class="post_content">
<p>Well I’ve only just started learning GoLang and its a lot to take in. But I can shadow and test if that helps, if not I will add it to my todo list and see what I can come up with as a pr towards the end of next week prob</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/515_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ajmckee</div>
          <div class="post_content">
<p>Okay so I have had some spare time to have a look at this issue and would value your advice <span class="mention">@hackerman</span> on this.</p>
<p>I was looking at taking your suggestion and writing the changes necessary for this to happen, i.e. provide a client property in the introspection response.</p>
<p>Well this got bigger than me quickly <img alt=":slight_smile:" class="emoji" src="../../../images/slight_smile.png" title=":slight_smile:"/></p>
<p>Within oath2/hander.go I’ve been looking at IntrospectHandler function.</p>
<p>From what I can see, the <code>resp.GetAccessRequester().GetClient()</code>returns a fosite Client interface (client.go). This interface does not have a getMetaData() sig.</p>
<p>This has me somewhat reluctant as it may be an issue as its a change to a core lib, fosite as well as to hydra.</p>
<p>My question here is, a) Is my observation correct and b) what way should I proceed. I would be happy to write the code and submit a PR (Least I could do) but as this is change to fosite I guess I am unsure which road to take.</p>
<p>Thanks<br/>
AJ</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/5_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">hackerman</div>
          <div class="post_content">
<p>I would also have to look into the code a bit, and it’s possible that we need to either define a new interface for metadata providers or change this another way. The best thing is probably throwing up a draft PR so I can look at the code <img alt=":slight_smile:" class="emoji" src="../../../images/slight_smile.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>
